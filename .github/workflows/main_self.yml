name: build profile assets on self-hosted runner

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  check-self-hosted-runner:
    runs-on: ubuntu-latest
    outputs:
      runner_online: ${{ steps.check.outputs.online }}
    steps:
      - name: Check self-hosted runner status
        id: check
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -e
          runners=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runners)

          online=$(echo "$runners" | jq '[.runners[] | select(.status=="online")] | length')
          if [ "$online" -gt 0 ]; then
            echo "online=true" >> "$GITHUB_OUTPUT"
          else
            echo "online=false" >> "$GITHUB_OUTPUT"
          fi
          echo "online runner count = $online"


  generate-pacman-graph-widget:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: generate pacman-contribution-graph.svg
        uses: abozanona/pacman-contribution-graph@main
        with:
          github_user_name: ${{ github.repository_owner }}

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-assets
          path: dist
          if-no-files-found: ignore


  generate-youtube-music-widget:
    runs-on: [self-hosted, docker]
    needs:
      - generate-pacman-graph-widget
      - check-self-hosted-runner
    if: needs.check-self-hosted-runner.outputs.runner_online == 'true'
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout widget repo
        uses: actions/checkout@v4
        with:
          repository: daeun503/profile-music-widget
          ref: dev
          path: widget
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-assets
          path: widget/dist

      - name: Verify environment
        run: |
          python3 --version
          ffmpeg -version
          yt-dlp --version

      - name: generate youtube music widget (gif bg)
        env:
          YT_PLAYLIST_ID: PLrpWLWlmavXBXidc7niUbK3dK39KVnugD
          YT_THEME: default.svg
          YT_IS_GIF_BG: true
        run: |
          python3 widget/generate_widget.py

      - name: Upload dist artifacts (with youtube music widget)
        uses: actions/upload-artifact@v4
        with:
          name: dist-final
          path: widget/dist


  deploy:
    runs-on: ubuntu-latest
    needs: generate-youtube-music-widget
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-final
          path: dist

      - name: Deploy dist to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
          keep_history: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
